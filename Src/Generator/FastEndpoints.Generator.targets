<Project>

    <PropertyGroup>
        <GenerateSerializerContexts Condition="'$(GenerateSerializerContexts)' == ''">false</GenerateSerializerContexts>
        <GeneratorCliPath Condition="'$(GeneratorCliPath)' == ''">$(MSBuildThisFileDirectory)../tools/net8.0/FastEndpoints.Generator.Cli.dll</GeneratorCliPath>
        <SerializerContextOutputPath Condition="'$(SerializerContextOutputPath)' == ''">Generated/FastEndpoints</SerializerContextOutputPath>
    </PropertyGroup>

    <Target Name="GenerateFastEndpointsSerializerContexts"
            BeforeTargets="CoreCompile"
            Condition="'$(GenerateSerializerContexts)' == 'true' AND '$(DesignTimeBuild)' != 'true'">

        <Warning Text="FastEndpoints Generator CLI not found at: $(GeneratorCliPath). Serializer context generation will be skipped."
                 Condition="!Exists('$(GeneratorCliPath)')"/>

        <Message Text="FastEndpoints: Generating serializer contexts..." Importance="high"
                 Condition="Exists('$(GeneratorCliPath)')"/>

        <MakeDir Directories="$(SerializerContextOutputPath)"
                 Condition="Exists('$(GeneratorCliPath)')"/>

        <Exec Command="dotnet &quot;$(GeneratorCliPath)&quot; &quot;$(MSBuildProjectFullPath)&quot; --output &quot;$(SerializerContextOutputPath)&quot;"
              WorkingDirectory="$(ProjectDir)"
              StandardOutputImportance="normal"
              StandardErrorImportance="high"
              Condition="Exists('$(GeneratorCliPath)')"/>

    </Target>

</Project>