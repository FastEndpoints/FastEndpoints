<Project>

    <PropertyGroup>
        <GenerateSerializerContexts Condition="'$(GenerateSerializerContexts)' == ''">false</GenerateSerializerContexts>
        <SerializerContextOutputPath Condition="'$(SerializerContextOutputPath)' == ''">Generated/FastEndpoints</SerializerContextOutputPath>

        <!-- Extract package version from the build directory path when installed via NuGet (e.g., .../8.0.0-beta.8/build/) -->
        <!-- In dev mode, the parent folder is 'Generator', so we check if it looks like a version (contains digits) -->
        <_GeneratorPackageBuildDir>$([MSBuild]::NormalizeDirectory('$(MSBuildThisFileDirectory)'))</_GeneratorPackageBuildDir>
        <_GeneratorPackageVersionDir>$([System.IO.Directory]::GetParent('$(_GeneratorPackageBuildDir)'))</_GeneratorPackageVersionDir>
        <_GeneratorPackageVersion>$([System.IO.Path]::GetFileName('$(_GeneratorPackageVersionDir)'))</_GeneratorPackageVersion>
        <_GeneratorPackageVersionIsValid Condition="$(_GeneratorPackageVersion.Contains('.'))">true</_GeneratorPackageVersionIsValid>

        <!-- Use user-specified version, or extracted package version (if valid), or empty (will use - -prerelease) -->
        <GeneratorCliVersion Condition="'$(GeneratorCliVersion)' == '' AND '$(_GeneratorPackageVersionIsValid)' == 'true'">$(_GeneratorPackageVersion)</GeneratorCliVersion>
        <_GeneratorCliVersionArg Condition="'$(GeneratorCliVersion)' != ''">--version $(GeneratorCliVersion)</_GeneratorCliVersionArg>
        <_GeneratorCliPrereleaseArg Condition="'$(GeneratorCliVersion)' == ''">--prerelease</_GeneratorCliPrereleaseArg>
        <_FastEndpointsToolSentinel>$(IntermediateOutputPath)fastendpoints-tool.version</_FastEndpointsToolSentinel>

        <!-- Path to locally built CLI for development mode -->
        <_FastEndpointsCliDevPath>$(MSBuildThisFileDirectory)../Generator.Cli/bin/$(Configuration)/net8.0/FastEndpoints.Generator.Cli.dll</_FastEndpointsCliDevPath>
        <_FastEndpointsCliProjectPath>$(MSBuildThisFileDirectory)../Generator.Cli/FastEndpoints.Generator.Cli.csproj</_FastEndpointsCliProjectPath>
    </PropertyGroup>

    <!-- Target to build the CLI tool in development mode -->
    <Target Name="BuildFastEndpointsGeneratorCli"
            BeforeTargets="CoreCompile"
            Condition="'$(GenerateSerializerContexts)' == 'true' AND '$(DesignTimeBuild)' != 'true' AND Exists('$(_FastEndpointsCliProjectPath)') AND !Exists('$(_FastEndpointsCliDevPath)')">

        <Message Text="FastEndpoints: Building Generator.Cli tool..." Importance="high"/>

        <Exec Command="dotnet build &quot;$(_FastEndpointsCliProjectPath)&quot; -c $(Configuration)"
              WorkingDirectory="$(MSBuildThisFileDirectory).."
              StandardOutputImportance="low"
              StandardErrorImportance="high"/>

    </Target>

    <!-- Target to install/update the FastEndpoints.Generator.Cli tool -->
    <!-- Only runs when NOT in development mode (i.e., CLI project doesn't exist) -->
    <Target Name="InstallFastEndpointsGeneratorTool"
            BeforeTargets="CoreCompile"
            Condition="'$(GenerateSerializerContexts)' == 'true' AND '$(DesignTimeBuild)' != 'true' AND !Exists('$(_FastEndpointsCliProjectPath)')">

        <!-- Read the currently installed version from sentinel file -->
        <ReadLinesFromFile File="$(_FastEndpointsToolSentinel)" Condition="Exists('$(_FastEndpointsToolSentinel)')">
            <Output TaskParameter="Lines" PropertyName="_InstalledToolVersion"/>
        </ReadLinesFromFile>

        <!-- Skip if version matches -->
        <PropertyGroup>
            <_ToolVersionMismatch Condition="'$(_InstalledToolVersion)' != '$(GeneratorCliVersion)'">true</_ToolVersionMismatch>
        </PropertyGroup>

        <!-- Install/update if:
             - Sentinel doesn't exist (first time), OR
             - Version doesn't match what was installed, OR  
             - No version specified (need to check for updates to latest) -->
        <PropertyGroup>
            <_ShouldInstallTool Condition="!Exists('$(_FastEndpointsToolSentinel)')">true</_ShouldInstallTool>
            <_ShouldInstallTool Condition="'$(_ToolVersionMismatch)' == 'true'">true</_ShouldInstallTool>
            <_ShouldInstallTool Condition="'$(GeneratorCliVersion)' == ''">true</_ShouldInstallTool>
        </PropertyGroup>

        <CallTarget Targets="_DoInstallFastEndpointsGeneratorTool" Condition="'$(_ShouldInstallTool)' == 'true'"/>

    </Target>

    <Target Name="_DoInstallFastEndpointsGeneratorTool">

        <!-- Ensure tool manifest exists (required for local tools) -->
        <Exec Command="dotnet new tool-manifest"
              WorkingDirectory="$(ProjectDir)"
              IgnoreExitCode="true"
              StandardOutputImportance="low"
              StandardErrorImportance="low"/>

        <!-- Try to install the tool (succeeds if not present, fails if already installed) -->
        <Exec Command="dotnet tool install --local FastEndpoints.Generator.Cli $(_GeneratorCliVersionArg) $(_GeneratorCliPrereleaseArg)"
              WorkingDirectory="$(ProjectDir)"
              IgnoreExitCode="true"
              StandardOutputImportance="low"
              StandardErrorImportance="normal">
            <Output TaskParameter="ExitCode" PropertyName="_ToolInstallExitCode"/>
        </Exec>

        <!-- If install failed (tool already exists), update it -->
        <Exec Command="dotnet tool update --local FastEndpoints.Generator.Cli $(_GeneratorCliVersionArg) $(_GeneratorCliPrereleaseArg)"
              WorkingDirectory="$(ProjectDir)"
              IgnoreExitCode="true"
              StandardOutputImportance="low"
              StandardErrorImportance="normal"
              Condition="'$(_ToolInstallExitCode)' != '0'"/>

        <!-- Write the version to the sentinel file -->
        <WriteLinesToFile File="$(_FastEndpointsToolSentinel)" Lines="$(GeneratorCliVersion)" Overwrite="true"/>

    </Target>

    <!-- Target to generate serializer contexts using the CLI tool -->
    <Target Name="GenerateFastEndpointsSerializerContexts"
            BeforeTargets="CoreCompile"
            DependsOnTargets="BuildFastEndpointsGeneratorCli;InstallFastEndpointsGeneratorTool"
            Condition="'$(GenerateSerializerContexts)' == 'true' AND '$(DesignTimeBuild)' != 'true'">

        <Message Text="FastEndpoints: Generating serializer contexts..." Importance="high"/>

        <MakeDir Directories="$(SerializerContextOutputPath)"/>

        <!-- Use local CLI in dev mode if available, otherwise use global tool -->
        <PropertyGroup>
            <_CliCommand Condition="Exists('$(_FastEndpointsCliDevPath)')">dotnet &quot;$(_FastEndpointsCliDevPath)&quot;</_CliCommand>
            <_CliCommand Condition="!Exists('$(_FastEndpointsCliDevPath)')">dotnet tool run fastendpoints-generator</_CliCommand>
        </PropertyGroup>

        <Exec Command="$(_CliCommand) &quot;$(MSBuildProjectFullPath)&quot; --output &quot;$(SerializerContextOutputPath)&quot;"
              WorkingDirectory="$(ProjectDir)"
              StandardOutputImportance="normal"
              StandardErrorImportance="high"/>

    </Target>

</Project>