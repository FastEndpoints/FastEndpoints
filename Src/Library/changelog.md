
---

### ✨ Looking For Sponsors ✨

FastEndpoints needs sponsorship to [sustain the project](https://github.com/FastEndpoints/FastEndpoints/issues/449). Please help out if you can.

---

<!-- <details><summary>title text</summary></details> -->

## 🔖 New

<details><summary>Integration testing with fake/test handlers for messaging features</summary>

Both `In-Proc` and `RPC` based messaging functionality can now be easily integration tested by registering fake/test handlers during testing. See below links for examples of each:

- [Command Bus](https://fast-endpoints.com/docs/command-bus) ([example](https://github.com/FastEndpoints/FastEndpoints/blob/fcb18db8e938fc850ea517d298ecaadd869d0f7c/Tests/IntegrationTests/FastEndpoints/CommandBusTests/CommandBusTests.cs#L73-L84))
- [Job Queues](https://fast-endpoints.com/docs/job-queues#queueing-a-job) ([example](https://github.com/FastEndpoints/Job-Queue-Demo/tree/main/Test))
- [Event Bus](https://fast-endpoints.com/docs/event-bus) ([example](https://github.com/FastEndpoints/FastEndpoints/blob/fcb18db8e938fc850ea517d298ecaadd869d0f7c/Tests/IntegrationTests/FastEndpoints/EventBusTests/EventBusTests.cs#L22-L35))
- [Event-Queue/Broker](https://fast-endpoints.com/docs/remote-procedure-calls#remote-pub-sub-event-queues) ([example](https://github.com/FastEndpoints/Event-Broker-Demo/tree/main/Test))

</details>

<details><summary>[DontRegister] attribute for skipping auto registration</summary>

Any auto discovered types (endpoints/commands/events/etc.) can be annotated with the attribute `[DontRegister]` if you'd like it to be skipped while assembly scanning for auto registration.

</details>

<details><summary>Auto instantiation of 'JsonSerializerContext' with global 'SerializerOptions'</summary>

```cs
public override void Configure()
{
    ...
    SerializerContext<UpdateAddressCtx>();
}
```

By specifying just the type of the serializer context, instead of supplying an instance as with the existing method, the context will be created using the `SerializerOptions` that you've configured at startup using the `UseFastEndpoints(...)` call.

</details>

<details><summary>Auto generation of examples for swagger request parameters</summary>

Take the following example request DTO:
```cs
sealed class MyRequest
{
    [QueryParam]
    public Nested ComplexObject { get; set; }
}

sealed class Nested
{
    [DefaultValue(100)]
    public int Id { get; set; }

    [DefaultValue("John Doe")]
    public string Name { get; set; }

    [DefaultValue(new[] { 1, 2, 3 })]
    public int[] Numbers { get; set; }
}
```

The following swagger spec `example` will now be auto generated by default:

```json
{
  "paths": {
    "/my-endpoint": {
      "get": {
        "parameters": [
          {
            "example": {
              "id": 100,
              "name": "John Doe",
              "numbers": [ 1,2,3 ]
            }
          }
        ]
      }
    }
  }
}
```

This behavior can be turned off like so:
```cs
builder.Services.SwaggerDocument(o =>
{
    o.DocumentSettings = s =>
    {
        s.GenerateExamples = false;
    };
});
```

</details>

<details><summary>NSwag serializer (Newtonsoft) customization</summary>

Since NSwag still uses Newtonsoft internally, it is sometimes necessary to register custom converters for the NewtonSoft serializer, which can now be achieved like so:

```cs
.SwaggerDocument(o =>
{
    o.NewtonsoftSettings = s =>
    {
        s.Converters.Add(new MyCustomConverter());
    };
});
```
Any other Newtonsoft settings that needs to be tuned can also be accessed via the `s` parameter.

</details>

## 🚀 Improvements

<details><summary>Minor performance optimizations</summary>

- Job queue message pump improvements
- Startup code optimizations

</details>

<details><summary>Concurrent WAF testing</summary>

- Better thread safety of `EndpointData` when running concurrent integration tests
- Avoid potential contention issues for `Event Handlers` when integration testing

</details>

<details><summary>Unit testing improvements</summary>

- Warn user if internal `ServiceResolver` is null due to incorrect unit test setup

</details>

## 🪲 Fixes

<details><summary>Event handler constructors being called twice</summary>

Due to an oversight in `IEnumerable` iteration, the event handler constructor was being called twice per execution. Thank you [Wahid Bitar](https://github.com/WahidBitar) for reporting it.

</details>

<details><summary>Json serializer context was not correctly copying 'JsonSerializerOptions'</summary>

`SerializerContext<TContext>()` was not properly making a copy of the global `JsonSerializerOptions` when the serializer context was being instantiated; leading to the same global options instance being bound to multiple serializer contexts, which is not supported by the SDK as of .NET 7.0.

</details>

<details><summary>Startup exception edge case</summary>

If `app.MapControllers()` call was placed before the `app.UseFastEndpoints()` call, the app would randomly throw a cryptic exception at startup. Now when this misconfiguration is detected, a clear exception would be thrown instructing the user to change the middleware order.

</details>

<!-- ## ⚠️ Minor Breaking Changes -->