<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

    <PropertyGroup>
        <SuppressTrimAnalysisWarnings>true</SuppressTrimAnalysisWarnings>
        <SuppressAotAnalysisWarnings>true</SuppressAotAnalysisWarnings>
        <SwaggerExportPath Condition="'$(SwaggerExportPath)' == ''">wwwroot/openapi</SwaggerExportPath>
    </PropertyGroup>

    <!-- Generate module initializer to set SwaggerExportPath at runtime -->
    <Target Name="GenerateSwaggerExportPathInitializer"
            BeforeTargets="CoreCompile"
            Condition="'$(MSBuildProjectName)' != 'FastEndpoints.Swagger'">
        <PropertyGroup>
            <_SwaggerInitFile>$(IntermediateOutputPath)SwaggerExportPathInitializer.g.cs</_SwaggerInitFile>
            <_SwaggerInitFileContent>
using System.Runtime.CompilerServices%3b
namespace FastEndpoints.Swagger%3b
internal static class SwaggerExportPathInitializer
{
    [ModuleInitializer]
    internal static void Initialize() => DocumentOptions.SwaggerExportPath = "$(SwaggerExportPath)"%3b
}
            </_SwaggerInitFileContent>
        </PropertyGroup>
        <WriteLinesToFile File="$(_SwaggerInitFile)" Lines="$(_SwaggerInitFileContent)" Overwrite="true"/>
        <ItemGroup>
            <Compile Include="$(_SwaggerInitFile)"/>
        </ItemGroup>
    </Target>

    <!-- Export swagger docs via JIT build before AOT publish (NSwag doesn't support AOT) -->
    <Target Name="ExportSwaggerDocsBeforeAotPublish"
            BeforeTargets="PrepareForILLink"
            Condition="'$(ExportSwaggerDocs)' == 'true' AND '$(PublishAot)' == 'true' AND '$(_SwaggerDocsExporting)' != 'true'">

        <PropertyGroup>
            <_SwaggerExportDir>$(IntermediateOutputPath)swagger_export\</_SwaggerExportDir>
        </PropertyGroup>

        <Message Text="Exporting Swagger documents before Native AOT compilation..." Importance="high"/>
        <Message Text="Swagger export path: $(SwaggerExportPath)" Importance="high"/>

        <!-- Build JIT version (non-AOT) with SwaggerExportPath explicitly passed -->
        <MSBuild Projects="$(MSBuildProjectFullPath)"
                 Targets="Build"
                 Properties="PublishAot=false;_SwaggerDocsExporting=true;SwaggerExportPath=$(SwaggerExportPath);OutputPath=$(_SwaggerExportDir)"/>

        <!-- Run the JIT build to export swagger docs -->
        <Exec Command="dotnet exec $(_SwaggerExportDir)$(AssemblyName).dll --export-swagger-docs true"
              WorkingDirectory="$(MSBuildProjectDirectory)"
              IgnoreExitCode="true">
            <Output TaskParameter="ExitCode" PropertyName="_SwaggerExportExitCode"/>
        </Exec>

        <Warning Text="Swagger document export failed with exit code $(_SwaggerExportExitCode)"
                 Condition="'$(_SwaggerExportExitCode)' != '0'"/>
        <Message Text="Swagger documents exported successfully" Importance="high"
                 Condition="'$(_SwaggerExportExitCode)' == '0'"/>

        <!-- Copy exported files to publish directory -->
        <ItemGroup Condition="'$(_SwaggerExportExitCode)' == '0' AND '$(PublishDir)' != ''">
            <_SwaggerFiles Include="$(MSBuildProjectDirectory)\$(SwaggerExportPath)\**\*"/>
        </ItemGroup>
        <Copy SourceFiles="@(_SwaggerFiles)"
              DestinationFolder="$(PublishDir)$(SwaggerExportPath)\%(RecursiveDir)"
              Condition="'@(_SwaggerFiles)' != ''"
              SkipUnchangedFiles="true"/>
    </Target>

</Project>